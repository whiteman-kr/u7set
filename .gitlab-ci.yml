variables:
  GIT_DEPTH: "1"
  
stages:
  - build
  - test
#  - deploy

before_script:
#  - echo before_script
  - cd
  - dir
  - set
  
#after_script:
#  - echo after_script

windows build job:
  stage: build
  only:
    - master
    - /^release.*$/
    - develop
    - experimental
  tags:
    - vs2017
  script:
    - "echo %CI_COMMIT_SHA%"
    - "git status"
    - "git log -1"
    - "set QT_BIN_DIR=C:\\Qt\\5.15.0\\msvc2019_64"
#generation version file
    - "echo #pragma once > gitlabci_version.h"
    - "echo. >> gitlabci_version.h"
    - "echo #define GITLAB_CI_BUILD >> gitlabci_version.h"
    - "echo #define CI_BUILD_REF_SLUG \"%CI_BUILD_REF_SLUG%\" >> gitlabci_version.h"
    - "echo #define CI_COMMIT_SHA \"%CI_COMMIT_SHA%\" >> gitlabci_version.h"
    - "echo #define GITLAB_USER_NAME \"%GITLAB_USER_NAME%\" >> gitlabci_version.h"
    - "echo #define CI_PIPELINE_ID %CI_PIPELINE_ID% >> gitlabci_version.h"
    - "echo #define COMPUTERNAME \"%COMPUTERNAME%\" >> gitlabci_version.h"
    - "echo #define BUILD_DATE \"%date% %time%\" >> gitlabci_version.h"
    - "call \"C:/Program Files (x86)/Microsoft Visual Studio/2019/BuildTools/VC/Auxiliary/Build/vcvarsall.bat\" x86_amd64"
#Build Project
    - "rem ----------------------------------------------"
    - "rem               Build Project"
    - "rem ----------------------------------------------"    
    - "cl.exe"
    - "%QT_BIN_DIR%/bin/qmake --version"
    - "%QT_BIN_DIR%/bin/qmake.exe %CI_PROJECT_DIR%/u7set.pro -spec win32-msvc"
    - "C:/Qt/Tools/QtCreator/bin/jom.exe qmake_all"
    - "C:/Qt/Tools/QtCreator/bin/jom.exe"
#Copy Qt DLLs to bin/release
    - "rem ----------------------------------------------"
    - "rem               Copy Qt DLL's"
    - "rem ----------------------------------------------"
    - "copy \"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\BuildTools\\VC\\Redist\\MSVC\\v142\\vcredist_x64.exe\" \"%CI_PROJECT_DIR%/bin/release/\""    
    - "copy C:\\libpq_my_build\\libpq.dll \"%CI_PROJECT_DIR%/bin/release/\""
    - "copy %QT_BIN_DIR%\\bin\\libEGL.dll \"%CI_PROJECT_DIR%/bin/release/\""
    - "copy %QT_BIN_DIR%\\bin\\libGLESv2.dll \"%CI_PROJECT_DIR%/bin/release/\""
    - "copy %QT_BIN_DIR%\\bin\\Qt5Core.dll \"%CI_PROJECT_DIR%/bin/release/\""
    - "copy %QT_BIN_DIR%\\bin\\Qt5Gui.dll \"%CI_PROJECT_DIR%/bin/release/\""
    - "copy %QT_BIN_DIR%\\bin\\Qt5Network.dll \"%CI_PROJECT_DIR%/bin/release/\""
    - "copy %QT_BIN_DIR%\\bin\\Qt5PrintSupport.dll \"%CI_PROJECT_DIR%/bin/release/\""
    - "copy %QT_BIN_DIR%\\bin\\Qt5Qml.dll \"%CI_PROJECT_DIR%/bin/release/\""
    - "copy %QT_BIN_DIR%\\bin\\Qt5Quick.dll \"%CI_PROJECT_DIR%/bin/release/\""
    - "copy %QT_BIN_DIR%\\bin\\Qt5SerialPort.dll \"%CI_PROJECT_DIR%/bin/release/\""
    - "copy %QT_BIN_DIR%\\bin\\Qt5Sql.dll \"%CI_PROJECT_DIR%/bin/release/\""
    - "copy %QT_BIN_DIR%\\bin\\Qt5Svg.dll \"%CI_PROJECT_DIR%/bin/release/\""
    - "copy %QT_BIN_DIR%\\bin\\Qt5Test.dll \"%CI_PROJECT_DIR%/bin/release/\""
    - "copy %QT_BIN_DIR%\\bin\\Qt5Widgets.dll \"%CI_PROJECT_DIR%/bin/release/\""
    - "copy %QT_BIN_DIR%\\bin\\Qt5Xml.dll \"%CI_PROJECT_DIR%/bin/release/\""
# Copy Qt plugins
    - "mkdir \"%CI_PROJECT_DIR%/bin/release/bearer\""
    - "copy %QT_BIN_DIR%\\plugins\\bearer\\qgenericbearer.dll \"%CI_PROJECT_DIR%/bin/release/bearer/\""
    - "mkdir \"%CI_PROJECT_DIR%\\bin\\release\\iconengines\""
    - "copy %QT_BIN_DIR%\\plugins\\iconengines\\qsvgicon.dll \"%CI_PROJECT_DIR%/bin/release/iconengines/\""
    - "mkdir \"%CI_PROJECT_DIR%\\bin\\release\\imageformats\""
    - "copy %QT_BIN_DIR%\\plugins\\imageformats\\qgif.dll \"%CI_PROJECT_DIR%/bin/release/imageformats/\""
    - "copy %QT_BIN_DIR%\\plugins\\imageformats\\qicns.dll \"%CI_PROJECT_DIR%/bin/release/imageformats/\""
    - "copy %QT_BIN_DIR%\\plugins\\imageformats\\qico.dll \"%CI_PROJECT_DIR%/bin/release/imageformats/\""
    - "copy %QT_BIN_DIR%\\plugins\\imageformats\\qjpeg.dll \"%CI_PROJECT_DIR%/bin/release/imageformats/\""
    - "copy %QT_BIN_DIR%\\plugins\\imageformats\\qsvg.dll \"%CI_PROJECT_DIR%/bin/release/imageformats/\""
    - "copy %QT_BIN_DIR%\\plugins\\imageformats\\qtga.dll \"%CI_PROJECT_DIR%/bin/release/imageformats/\""
    - "copy %QT_BIN_DIR%\\plugins\\imageformats\\qtiff.dll \"%CI_PROJECT_DIR%/bin/release/imageformats/\""
    - "copy %QT_BIN_DIR%\\plugins\\imageformats\\qwbmp.dll \"%CI_PROJECT_DIR%/bin/release/imageformats/\""
    - "copy %QT_BIN_DIR%\\plugins\\imageformats\\qwebp.dll \"%CI_PROJECT_DIR%/bin/release/imageformats/\""
    - "mkdir \"%CI_PROJECT_DIR%\\bin\\release\\platforms\""
    - "copy %QT_BIN_DIR%\\plugins\\platforms\\qdirect2d.dll \"%CI_PROJECT_DIR%/bin/release/platforms/\""
    - "copy %QT_BIN_DIR%\\plugins\\platforms\\qminimal.dll \"%CI_PROJECT_DIR%/bin/release/platforms/\""
    - "copy %QT_BIN_DIR%\\plugins\\platforms\\qoffscreen.dll \"%CI_PROJECT_DIR%/bin/release/platforms/\""
    - "copy %QT_BIN_DIR%\\plugins\\platforms\\qwindows.dll \"%CI_PROJECT_DIR%/bin/release/platforms/\""
    - "mkdir \"%CI_PROJECT_DIR%\\bin\\release\\sqldrivers\""
    - "copy %QT_BIN_DIR%\\plugins\\sqldrivers\\qsqlite.dll \"%CI_PROJECT_DIR%/bin/release/sqldrivers/\""
    - "copy %QT_BIN_DIR%\\plugins\\sqldrivers\\qsqlpsql.dll \"%CI_PROJECT_DIR%/bin/release/sqldrivers/\""
    - "mkdir \"%CI_PROJECT_DIR%\\bin\\release\\printsupport\""
    - "copy %QT_BIN_DIR%\\plugins\\printsupport\\windowsprintersupport.dll \"%CI_PROJECT_DIR%/bin/release/printsupport/\""
    - "mkdir \"%CI_PROJECT_DIR%\\bin\\release\\styles\""
    - "copy %QT_BIN_DIR%\\plugins\\styles\\qwindowsvistastyle.dll \"%CI_PROJECT_DIR%/bin/release/styles/\""

#Remove some files not requiered for releases
    - "rem ----------------------------------------------"
    - "rem               Remove some files not requiered for releases"
    - "rem ----------------------------------------------"
#    - "del /F /Q bin\\release\\BuilderConsole.exe"
    - "del /F /Q bin\\release\\BaseSrv.exe"
    - "del /F /Q bin\\release\\CommView.exe"
    - "del /F /Q bin\\release\\DiagDataSrv.exe"
#    - "del /F /Q bin\\release\\SimulatorConsole.exe"
    - "del /F /Q bin\\release\\TuningIPEN.exe"
#    - "del /F /Q bin\\release\\u7databasetests.exe"
    
#Signing Files
    - "rem ----------------------------------------------"
    - "rem               Sign Files"
    - "rem ----------------------------------------------"
    - "set /p K8S_SECRET_DIGITAL_SIGN_CERT=<c:\\radiy-code-signing\\password.txt"
    - "signtool.exe sign /tr http://timestamp.digicert.com /fd SHA256 /f c:\\radiy-code-signing\\radiy-code-signing.pfx /p %K8S_SECRET_DIGITAL_SIGN_CERT% bin\\release\\VFrame30.dll"
    - "signtool.exe sign /tr http://timestamp.digicert.com /fd SHA256 /f c:\\radiy-code-signing\\radiy-code-signing.pfx /p %K8S_SECRET_DIGITAL_SIGN_CERT% bin\\release\\AppDataSrv.exe"
    - "signtool.exe sign /tr http://timestamp.digicert.com /fd SHA256 /f c:\\radiy-code-signing\\radiy-code-signing.pfx /p %K8S_SECRET_DIGITAL_SIGN_CERT% bin\\release\\ArchSrv.exe"
    - "signtool.exe sign /tr http://timestamp.digicert.com /fd SHA256 /f c:\\radiy-code-signing\\radiy-code-signing.pfx /p %K8S_SECRET_DIGITAL_SIGN_CERT% bin\\release\\CfgSrv.exe"
    - "signtool.exe sign /tr http://timestamp.digicert.com /fd SHA256 /f c:\\radiy-code-signing\\radiy-code-signing.pfx /p %K8S_SECRET_DIGITAL_SIGN_CERT% bin\\release\\mconf.exe"
    - "signtool.exe sign /tr http://timestamp.digicert.com /fd SHA256 /f c:\\radiy-code-signing\\radiy-code-signing.pfx /p %K8S_SECRET_DIGITAL_SIGN_CERT% bin\\release\\PacketSource.exe"
    - "signtool.exe sign /tr http://timestamp.digicert.com /fd SHA256 /f c:\\radiy-code-signing\\radiy-code-signing.pfx /p %K8S_SECRET_DIGITAL_SIGN_CERT% bin\\release\\PacketViewer.exe"
    - "signtool.exe sign /tr http://timestamp.digicert.com /fd SHA256 /f c:\\radiy-code-signing\\radiy-code-signing.pfx /p %K8S_SECRET_DIGITAL_SIGN_CERT% bin\\release\\Metrology.exe"
    - "signtool.exe sign /tr http://timestamp.digicert.com /fd SHA256 /f c:\\radiy-code-signing\\radiy-code-signing.pfx /p %K8S_SECRET_DIGITAL_SIGN_CERT% bin\\release\\Monitor.exe"
    - "signtool.exe sign /tr http://timestamp.digicert.com /fd SHA256 /f c:\\radiy-code-signing\\radiy-code-signing.pfx /p %K8S_SECRET_DIGITAL_SIGN_CERT% bin\\release\\scm.exe"
    - "signtool.exe sign /tr http://timestamp.digicert.com /fd SHA256 /f c:\\radiy-code-signing\\radiy-code-signing.pfx /p %K8S_SECRET_DIGITAL_SIGN_CERT% bin\\release\\TuningClient.exe"
    - "signtool.exe sign /tr http://timestamp.digicert.com /fd SHA256 /f c:\\radiy-code-signing\\radiy-code-signing.pfx /p %K8S_SECRET_DIGITAL_SIGN_CERT% bin\\release\\TuningSrv.exe"
    - "signtool.exe sign /tr http://timestamp.digicert.com /fd SHA256 /f c:\\radiy-code-signing\\radiy-code-signing.pfx /p %K8S_SECRET_DIGITAL_SIGN_CERT% bin\\release\\u7.exe"    

#Generate ScriptHelp
    - "rem ----------------------------------------------"
    - "rem               Generate ScriptHelp"
    - "rem ----------------------------------------------"
    - "pushd ."	
    - "cd %CI_PROJECT_DIR%\\u7\\ScriptHelp"
    - "call ScriptHelp.bat"
    - "popd ."

#Request documents from SVN
    - "rem ----------------------------------------------"
    - "rem               Request documents from SVN"
    - "rem ----------------------------------------------"
    - "pushd ."	
    - "cd %CI_PROJECT_DIR%\\doc"
    - "call SvnGetDocs.bat"
    - "popd ."

#Build Installer
    - "rem ----------------------------------------------"
    - "rem               Build Installer"
    - "rem ----------------------------------------------"
    - "pushd ."	
    - "cd %CI_PROJECT_DIR%\\u7setinstall"
    - "call createinstall.bat"
    - "popd ."	
    - "signtool.exe sign /tr http://timestamp.digicert.com /fd SHA256 /f c:\\radiy-code-signing\\radiy-code-signing.pfx /p %K8S_SECRET_DIGITAL_SIGN_CERT% bin\\*.exe"
    - "set K8S_SECRET_DIGITAL_SIGN_CERT="

  artifacts:
    name: "u7set_0.8.%CI_PIPELINE_ID%_%CI_BUILD_REF_SLUG%_%CI_COMMIT_SHA%"
    paths:
      - bin/*.exe
      - bin/release/*.exe
      - bin/release/*.dll
      - bin/release/bearer/*.dll
      - bin/release/iconengines/*.dll
      - bin/release/imageformats/*.dll
      - bin/release/platforms/*.dll
      - bin/release/sqldrivers/*.dll
      - bin/release/printsupport/*.dll
      - bin/release/styles/*.dll
      - bin/release/scripthelp/*.*
      - bin/release/scripthelp/search/*.*
      - bin/release/docs/*.pdf
      - bin/release/docs/Appendixes/*.pdf

test job:
  stage: test
  tags:
    - test
  only:
    - master
    - /^release.*$/
    - develop
    - experimental
  script:
    - "echo %CI_COMMIT_SHA%"
    - "git status"
    - "git log -1"
#Run XML validation
    - "rem ----------------------------------------------"
    - "rem               Run XML validation"
    - "rem ----------------------------------------------"
    - "pushd ."	
    - "cd %CI_PROJECT_DIR%\\u7\\LogicModuleDescription"
    - "call validate_xmls.bat"
    - "popd ."

#Run unit tests
    - "rem ----------------------------------------------"
    - "rem               Run unit tests"
    - "rem ----------------------------------------------"
    - "%CI_PROJECT_DIR%\\bin\\release\\u7databasetests.exe"

#Run Builder test
    - "rem ----------------------------------------------"
    - "rem               Run BuilderConsole tests"
    - "rem ----------------------------------------------"
    - "rmdir /Q /S c:\\temp\\build\\test_simulator-debug"
    - "%CI_PROJECT_DIR%\\bin\\release\\BuilderConsole.exe %CI_PROJECT_DIR%\\Test\\BuilderConsoleArgs.xml"

#Run Sim AFB Tests
    - "rem ----------------------------------------------"
    - "rem               Run Simulator AFBs tests"
    - "rem ----------------------------------------------"
    - "%CI_PROJECT_DIR%\\bin\\release\\SimulatorConsole.exe c:\\temp\\build\\test_simulator_v334-debug\\build %CI_PROJECT_DIR%\\Simulator\\SimProjectTests.js"
